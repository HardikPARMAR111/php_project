<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>My Rentals</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="p-4">
  <div class="container">
    <h2 class="mb-4">My Rentals</h2>

    <table class="table table-striped" id="rentalsTable">
      <thead>
        <tr>
          <th>Book</th>
          <th>Rented At</th>
          <th>Due Date</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <p id="msg" class="mt-3"></p>
  </div>

<script>
const API = "http://localhost/php_project/backend/index.php";
const tbody = document.querySelector('#rentalsTable tbody');
const msg = document.getElementById('msg');

// Unified user getter (supports both 'user' object and separate keys)
function getUser() {
  const userStr = localStorage.getItem('user');
  if (userStr) {
    try {
      return JSON.parse(userStr);
    } catch (e) {
      console.error("Error parsing user from localStorage:", e);
    }
  }

  const userId = localStorage.getItem('userId');
  const name = localStorage.getItem('name');
  const email = localStorage.getItem('email');

  if (userId) {
    return { id: userId, name, email };
  }

  return null;
}

const user = getUser();

if (!user || !user.id) {
  tbody.innerHTML = `
    <tr>
      <td colspan="5" class="text-center">
        Please log in first.
        <a href="login.html" class="btn btn-sm btn-primary ms-2">Login</a>
      </td>
    </tr>`;
} else {
  loadRentals();
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  if (isNaN(d.getTime())) return dateStr; // fallback to raw string
  return d.toLocaleString();
}

async function loadRentals() {
  msg.textContent = '';
  tbody.innerHTML = `
    <tr>
      <td colspan="5" class="text-center text-muted">
        Loading rentals...
      </td>
    </tr>`;

  try {
    const res = await fetch(`${API}?action=getUserRentals&user_id=${encodeURIComponent(user.id)}`);
    if (!res.ok) throw new Error(`HTTP error ${res.status}`);
    const json = await res.json();

    if (!json.success) {
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">${json.message || 'Failed to load rentals'}</td></tr>`;
      return;
    }

    const rentals = json.data || [];

    if (rentals.length === 0) {
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">You have no rentals yet.</td></tr>`;
      return;
    }

    tbody.innerHTML = '';

    for (const r of rentals) {
      let title = r.book_id; // fallback

      // fetch book details (best-effort; don't break if it fails)
      try {
        const bookRes = await fetch(`${API}?action=getBook&id=${encodeURIComponent(r.book_id)}`);
        if (bookRes.ok) {
          const bookJson = await bookRes.json();
          if (bookJson.success && bookJson.data && bookJson.data.title) {
            title = bookJson.data.title;
          }
        }
      } catch (e) {
        console.warn("Failed to fetch book details for", r.book_id, e);
      }

      const rentedAt = formatDate(r.rented_at);
      const dueDate = formatDate(r.due_date);
      const status = r.status || '';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${title}</td>
        <td>${rentedAt}</td>
        <td>${dueDate}</td>
        <td>
          <span class="badge ${status === 'rented' ? 'bg-warning text-dark' : 'bg-success'}">
            ${status.toUpperCase()}
          </span>
        </td>
        <td>
          ${
            status === 'rented'
              ? `<button class="btn btn-sm btn-success" data-id="${r.id}">Return</button>`
              : ''
          }
        </td>
      `;
      tbody.appendChild(tr);
    }

    // Attach event listeners for return buttons
    document.querySelectorAll('button[data-id]').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const rentalId = e.target.dataset.id;
        e.target.disabled = true;
        e.target.textContent = 'Returning...';

        try {
          const res = await fetch(`${API}?action=returnBook`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ rental_id: rentalId, user_id: user.id })
          });
          const j = await res.json();
          if (j.success) {
            msg.style.color = 'green';
            msg.textContent = j.message || 'Book returned successfully';
            setTimeout(() => loadRentals(), 700);
          } else {
            msg.style.color = 'red';
            msg.textContent = j.message || 'Failed to return book';
            e.target.disabled = false;
            e.target.textContent = 'Return';
          }
        } catch (error) {
          console.error("Error returning book:", error);
          msg.style.color = 'red';
          msg.textContent = 'Connection error while returning book';
          e.target.disabled = false;
          e.target.textContent = 'Return';
        }
      });
    });

  } catch (error) {
    console.error("Error loading rentals:", error);
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="text-center text-danger">
          Failed to load rentals: ${error.message}
        </td>
      </tr>`;
  }
}
</script>
</body>
</html>