<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>My Rentals</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="p-4">
  <div class="container">
    <h2>My Rentals</h2>
    <table class="table" id="rentalsTable">
      <thead><tr><th>Book</th><th>Rented At</th><th>Due Date</th><th>Status</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>
    <p id="msg"></p>
  </div>

<script>
const API = "http://localhost/php_project/backend/index.php";
const user = JSON.parse(localStorage.getItem('user') || '{}');
const tbody = document.querySelector('#rentalsTable tbody');
const msg = document.getElementById('msg');

if (!user || !user.id) {
  tbody.innerHTML = '<tr><td colspan="5">Please log in first</td></tr>';
} else {
  loadRentals();
}

async function loadRentals(){
  const res = await fetch(`${API}?action=getUserRentals&user_id=${encodeURIComponent(user.id)}`);
  const json = await res.json();
  if (!json.success) {
    tbody.innerHTML = `<tr><td colspan="5">${json.message}</td></tr>`;
    return;
  }
  tbody.innerHTML = '';
  for (const r of json.data) {
    // fetch book details
    const bookRes = await fetch(`${API}?action=getBook&id=${r.book_id}`);
    const bookJson = await bookRes.json();
    const title = bookJson.success ? bookJson.data.title : r.book_id;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${title}</td>
      <td>${r.rented_at ?? ''}</td>
      <td>${r.due_date ?? ''}</td>
      <td>${r.status}</td>
      <td>
        ${r.status === 'rented' ? `<button class="btn btn-sm btn-success" data-id="${r.id}">Return</button>` : ''}
      </td>
    `;
    tbody.appendChild(tr);
  }

  // attach event listeners for return
  document.querySelectorAll('button[data-id]').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const rentalId = e.target.dataset.id;
      const res = await fetch(`${API}?action=returnBook`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ rental_id: rentalId, user_id: user.id })
      });
      const j = await res.json();
      if (j.success) {
        msg.style.color = 'green'; msg.innerText = j.message;
        setTimeout(() => loadRentals(), 700);
      } else {
        msg.style.color = 'red'; msg.innerText = j.message;
      }
    });
  });
}
</script>
</body>
</html>
