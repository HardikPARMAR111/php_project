<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body class="bg-light">

<div class="container mt-5">
  <div class="card p-4 shadow-sm">
    <h3 class="mb-4">My Profile</h3>

    <!-- View Mode -->
    <div id="viewMode">
      <p><strong>Name:</strong> <span id="profileName"></span></p>
      <p><strong>Email:</strong> <span id="profileEmail"></span></p>
      <button id="editBtn" class="btn btn-primary mt-3">Edit Profile</button>
    </div>

    <!-- Edit Mode (Hidden by default) -->
    <div id="editMode" style="display: none;">
      <form id="profileForm">
        <div class="mb-3">
          <label for="fullname" class="form-label">Full Name</label>
          <input type="text" class="form-control" id="fullname" required>
        </div>
        
        <div class="mb-3">
          <label for="email" class="form-label">Email</label>
          <input type="email" class="form-control" id="email" required>
        </div>
        
        <div class="mb-3">
          <label for="password" class="form-label">New Password (leave blank to keep current)</label>
          <input type="password" class="form-control" id="password">
        </div>
        
        <button type="submit" class="btn btn-success">Save Changes</button>
        <button type="button" id="cancelBtn" class="btn btn-secondary ms-2">Cancel</button>
      </form>
    </div>
  </div>

  <!-- User's Rental History -->
  <div class="card p-4 shadow-sm mt-4">
    <h4 class="mb-3">My Rented Books</h4>
    <div id="rentalList">
      <p class="text-muted">Loading...</p>
    </div>
  </div>
</div>

<script>
  const userId = localStorage.getItem("userId");

  // Check if user is logged in
  if (!userId) {
    alert("You are not logged in!");
    window.location.href = "login.html";
  }

  // Load user profile
  async function loadProfile() {
    try {
      const res = await fetch(`http://localhost/php_project/backend/index.php?action=getUser&id=${userId}`);
      const data = await res.json();

      console.log("Profile API Response:", data);

      if (data.success) {
        // Update view mode
        document.getElementById("profileName").textContent = data.data.name;
        document.getElementById("profileEmail").textContent = data.data.email;
        
        // Pre-fill edit form
        document.getElementById("fullname").value = data.data.name;
        document.getElementById("email").value = data.data.email;
      } else {
        alert("Failed to load profile: " + data.message);
      }
    } catch (error) {
      console.error("Error loading profile:", error);
      alert("Error loading profile");
    }
  }

  // Load user's rentals
  async function loadUserRentals() {
    try {
      const res = await fetch(`http://localhost/php_project/backend/index.php?action=getUserRentals&user_id=${userId}`);
      const data = await res.json();

      console.log("Rentals API Response:", data);

      const rentalList = document.getElementById("rentalList");

      if (data.success && data.data.length > 0) {
        rentalList.innerHTML = data.data.map(rental => `
          <div class="card mb-2 p-3">
            <p><strong>Book ID:</strong> ${rental.book_id}</p>
            <p><strong>Rented At:</strong> ${new Date(rental.rented_at).toLocaleDateString()}</p>
            <p><strong>Due Date:</strong> ${new Date(rental.due_date).toLocaleDateString()}</p>
            <p><strong>Status:</strong> 
              <span class="badge ${rental.status === 'rented' ? 'bg-warning' : 'bg-success'}">
                ${rental.status}
              </span>
            </p>
            ${rental.status === 'rented' ? `
              <button class="btn btn-sm btn-outline-primary" onclick="returnBook('${rental.id}')">
                Return Book
              </button>
            ` : ''}
          </div>
        `).join('');
      } else {
        rentalList.innerHTML = '<p class="text-muted">No rentals found.</p>';
      }
    } catch (error) {
      console.error("Error loading rentals:", error);
      document.getElementById("rentalList").innerHTML = '<p class="text-danger">Error loading rentals.</p>';
    }
  }

  // Return a book
  async function returnBook(rentalId) {
    if (!confirm("Are you sure you want to return this book?")) return;

    try {
      const res = await fetch("http://localhost/php_project/backend/index.php?action=returnBook", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          rental_id: rentalId,
          user_id: userId
        })
      });

      const data = await res.json();
      alert(data.message);

      if (data.success) {
        loadUserRentals(); // Refresh the list
      }
    } catch (error) {
      console.error("Error returning book:", error);
      alert("Error returning book");
    }
  }

  // Toggle edit mode
  document.getElementById("editBtn").addEventListener("click", () => {
    document.getElementById("viewMode").style.display = "none";
    document.getElementById("editMode").style.display = "block";
  });

  // Cancel edit
  document.getElementById("cancelBtn").addEventListener("click", () => {
    document.getElementById("viewMode").style.display = "block";
    document.getElementById("editMode").style.display = "none";
    document.getElementById("password").value = ""; // Clear password field
  });

  // Handle profile update
  document.getElementById("profileForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const fullname = document.getElementById("fullname").value.trim();
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;

    if (!fullname || !email) {
      alert("Name and email are required");
      return;
    }

    try {
      const res = await fetch("http://localhost/php_project/backend/index.php?action=updateUser", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          id: userId,
          name: fullname,
          email,
          password: password || undefined // Only send if not empty
        })
      });

      const data = await res.json();
      alert(data.message);

      if (data.success) {
        // Update localStorage
        localStorage.setItem("name", fullname);
        localStorage.setItem("email", email);
        
        // Update view mode display
        document.getElementById("profileName").textContent = fullname;
        document.getElementById("profileEmail").textContent = email;
        
        // Switch back to view mode
        document.getElementById("viewMode").style.display = "block";
        document.getElementById("editMode").style.display = "none";
        document.getElementById("password").value = "";
      }
    } catch (error) {
      console.error("Error updating profile:", error);
      alert("Error updating profile");
    }
  });

  // Initialize page
  loadProfile();
  loadUserRentals();
</script>

</body>
</html>